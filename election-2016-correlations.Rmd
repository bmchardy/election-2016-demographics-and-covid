---
title: 'A look at demographics, COVID-19, and elections data'
author: "Bobby McHardy"
date: "November 6, 2020"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
---


# Introduction!

We're going to explore relationships between political affiliation, demographics, and COVID-19 statistics. To do this, I've pulled together subsets of data from the New York Times' [COVID-19 dataset](https://github.com/nytimes/covid-19-data), the MIT Election Data and Science Lab's [County Presidential Election Returns 2000-2016 dataset](https://doi.org/10.7910/DVN/VOQCHQ), and 2016 [data from the US Census](https://www2.census.gov/programs-surveys/popest/datasets/2010-2019/counties/asrh/).

```{r preppack, include=FALSE}
library("tibble")
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(corrplot)
library(stringr)
options(scipen = 999)
rm(list = ls())
```

# Data Preparation

All data is by State and County, so we'll join all datasets together and select only the columns of interest.

## Loading in the data

We will now load in all required `.csv` data files, starting with the COVID-19 dataset. We only select the week leading up to Election 2020 and we compute average new cases and deaths by county.

```{r dataload_covid, warning=FALSE}
# set working directory
setwd("data")

# COVID-19 average cases and deaths by state and county in week leading up to 2020 election
data_counties <- as_tibble(read.csv("us-counties.csv")) %>%
  filter(date >= '2020-10-28') %>%
  filter(date <= '2020-11-03') %>%
  group_by(state, county, fips) %>%
  dplyr::summarize(cases_avg = mean(cases), deaths_avg = mean(deaths)) %>%
  select(state, county, fips, cases_avg, deaths_avg)
```

Load the Mask Use dataset and calculate a compsite measure. This dataset contains responses, by county, for percentages of people who report wearing masks "Always", "Frequently", "Sometimes", "Rarely", and "Never" We define

$$MaskPercentCompliance = ALWAYS + \frac{3}{4}FREQUENTLY + \frac{1}{2}SOMETIMES + \frac{1}{4}RARELY$$

to be the weighted average of these responses. Let's join this dataset to our COVID-19 data.

```{r dataload_masks, warning=FALSE}
setwd("data")
# join mask attitudes data
data_counties <- join(data_counties,
                      as_tibble(read.csv("./mask-use/mask-use-by-county.csv")) %>%
                        rename(fips = COUNTYFP) %>%
                        mutate(mask_pct_compliance = (ALWAYS + 0.75*FREQUENTLY + 0.5*SOMETIMES + 0.25*RARELY)),
                      by = "fips",
                      type = "left")
```

We now load demographics data for each county in the United States in 2016 so that we can temporally compare to the elections data that we'll load in next. Once again, we'll join this to our county table.

```{r dataload_demographics_2016, warning=FALSE}
setwd("data")
# join 2016 demographics data
data_counties <- join(data_counties,
                      as_tibble(read.csv("./us-counties-2016-census-data/cc-est2019-alldata-2016subset.csv")) %>%
                        mutate(white_pct_2016 = (WA_MALE + WA_FEMALE) / TOT_POP) %>%
                        rename(state = STNAME) %>%
                        mutate(county = str_replace(CTYNAME, " County", "")) %>%
                        rename(population = TOT_POP) %>%
                        select(state, county, population, white_pct_2016),
                      by = c("state", "county"),
                      type = "left")
```

Lastly, we load in data for the 2016 Presidential Election by county. We create a new composite measure

$$RepublicanPercent2016 = \frac{CandidateVotes_{Republican}}{TotalVotes}$$
of the percentage of votes in that county that were Republican (Trump) in 2016.

```{r dataload_elections_2016, warning=FALSE}
setwd("data")
# join 2016 presidential elections data
data_counties <- join(data_counties,
                      as_tibble(read.csv("./us-counties-2016-election/countypres_2000-2016.csv")) %>%
                        filter(year == '2016') %>%
                        filter(party == "republican") %>%
                        rename(fips = FIPS) %>%
                        mutate(republican_pct_2016 = candidatevotes / totalvotes) %>%
                        select(fips, republican_pct_2016),
                      by = "fips",
                      type = "left")
```

We select only the attributes of interest. Let's have a look at our data!

```{r dataload_org, warning=FALSE}
data_counties <- data_counties %>%
  mutate(norm_cases_avg = cases_avg / population) %>%
  mutate(norm_deaths_avg = deaths_avg / population) %>%
  select(state, county, norm_cases_avg, norm_deaths_avg, mask_pct_compliance,
         white_pct_2016, republican_pct_2016)

data_counties
```

```{r viz_scatter_cases_maskcompliance, message=FALSE, warning=FALSE}
fit <- lm(norm_cases_avg ~ mask_pct_compliance, data_counties)
data_counties %>%
    ggplot(., aes(x=mask_pct_compliance, y=norm_cases_avg)) +
    geom_point() +
    geom_smooth(method=lm) +
    geom_label(label = paste0("Adj. R = ", round((summary(fit)$adj.r.squared)^0.5, 3)),
               x=0.35, y=0.175, label.size = 0.35, color = "black", fill="white") +
    ggtitle("COVID-19 Cases by Mask Compliance") +
    xlim(0.3, 1.0) +
    ylim(0.0, 0.2)
rm(fit)
```

```{r viz_scatter_cases_demographics, message=FALSE, warning=FALSE}
fit <- lm(norm_cases_avg ~ white_pct_2016, data_counties)
data_counties %>%
    ggplot(., aes(x=white_pct_2016, y=norm_cases_avg)) +
    geom_point() +
    geom_smooth(method=lm) +
    geom_label(label = paste0("Adj. R = ", round((summary(fit)$adj.r.squared)^0.5, 3)),
               x=0.125, y=0.175, label.size = 0.35, color = "black", fill="white") +
    ggtitle("COVID-19 Cases by Demographics") +
    xlim(0.0, 1.0) +
    ylim(0.0, 0.2)
rm(fit)
```

```{r viz_scatter_cases_affiliation, message=FALSE, warning=FALSE}
fit <- lm(norm_cases_avg ~ republican_pct_2016, data_counties)
data_counties %>%
    ggplot(., aes(x=republican_pct_2016, y=norm_cases_avg)) +
    geom_point() +
    geom_smooth(method=lm) +
    geom_label(label = paste0("Adj. R = ", round((summary(fit)$adj.r.squared)^0.5, 3)),
               x=0.125, y=0.175, label.size = 0.35, color = "black", fill="white") +
    ggtitle("COVID-19 Cases by Political Affiliation") +
    xlim(0.0, 1.0) +
    ylim(0.0, 0.2)
rm(fit)
```

```{r viz_scatter_maskcompliance_demographics, message=FALSE, warning=FALSE}
fit <- lm(mask_pct_compliance ~ white_pct_2016, data_counties)
data_counties %>%
    ggplot(., aes(x=white_pct_2016, y=mask_pct_compliance)) +
    geom_point() +
    geom_smooth(method=lm) +
    geom_label(label = paste0("Adj. R = ", round((summary(fit)$adj.r.squared)^0.5, 3)),
               x=0.35, y=0.3, label.size = 0.35, color = "black", fill="white") +
    ggtitle("COVID-19 Mask Compliance by Demographics") +
    xlim(0.0, 1.0) +
    ylim(0.25, 1.0)
rm(fit)
```

```{r viz_scatter_maskcompliance_affiliation, message=FALSE, warning=FALSE}
fit <- lm(mask_pct_compliance ~ republican_pct_2016, data_counties)
data_counties %>%
    ggplot(., aes(x=republican_pct_2016, y=mask_pct_compliance)) +
    geom_point() +
    geom_smooth(method=lm) +
    geom_label(label = paste0("Adj. R = ", round((summary(fit)$adj.r.squared)^0.5, 3)),
               x=0.35, y=0.3, label.size = 0.35, color = "black", fill="white") +
    ggtitle("COVID-19 Mask Compliance by Affiliation") +
    xlim(0.0, 1.0) +
    ylim(0.25, 1.0)
rm(fit)
```

```{r viz_scatter_affiliation_demographics, message=FALSE, warning=FALSE}
fit <- lm(republican_pct_2016 ~ white_pct_2016, data_counties)
data_counties %>%
    ggplot(., aes(x=white_pct_2016, y=republican_pct_2016)) +
    geom_point() +
    geom_smooth(method=lm) +
    geom_label(label = paste0("Adj. R = ", round((summary(fit)$adj.r.squared)^0.5, 3)),
               x=0.25, y=0.75, label.size = 0.35, color = "black", fill="white") +
    ggtitle("Affiliation by Demographics") +
    xlim(0.0, 1.0) +
    ylim(0.0, 1.0)
rm(fit)
```